<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.StoredProcedureOraclev10g" name="SP_GET_SETTOP_BOX" directorySegmentName="seg_0" id="058AE2E8-5D11-2D44-E75E-49F3C356B4F3">
<sourceConnName>SOLO_Prod</sourceConnName>
<sourceObjSchema>CHTR</sourceObjSchema>
<sourceObjName>SP_GET_SETTOP_BOX</sourceObjName>
<createdBy>jandrews1</createdBy>
<createdTime>2015-08-11 13:13:39 UTC</createdTime>
<ownerDesignName>SOLO_DECEMBER_RE</ownerDesignName>
<owner>5AF9E3FC-7A76-C437-3E83-BF29D7EA2FC7</owner>
<source>CREATE OR REPLACE PROCEDURE      CHTR.SP_GET_SETTOP_BOX (&lt;br/&gt;   out_error_label     OUT      VARCHAR2,&lt;br/&gt;   out_stb_cur         OUT      pkg_osb_service.ref_cur_type,&lt;br/&gt;   in_audit_user       IN       VARCHAR2,&lt;br/&gt;   in_account_number   IN       VARCHAR2&lt;br/&gt;)&lt;br/&gt;AS&lt;br/&gt;   /*&lt;br/&gt;   ||==================================================================================================================&lt;br/&gt;   ||          Name: SP_GET_SETTOP_BOX&lt;br/&gt;   ||          Type: PROCEDURE&lt;br/&gt;   ||        Author: Senthil&lt;br/&gt;   ||  Created Date: 10/22/2014&lt;br/&gt;   ||&lt;br/&gt;   ||   Description: This procedure will return a list of equipment related to a customer party&lt;br/&gt;   ||&lt;br/&gt;   ||     Called By:&lt;br/&gt;   ||&lt;br/&gt;   || IN Parameters:&lt;br/&gt;   ||      in_account_number: account number (required)&lt;br/&gt;   ||              in account_number: Account number will map to the t_account table.&lt;br/&gt;   ||      in_audit_user: user invoking object&lt;br/&gt;   ||&lt;br/&gt;   || OUT Parameters:&lt;br/&gt;   ||      out_stb_cur (ref cursor) returned columns:&lt;br/&gt;   ||                      serial_num: equipment serial number&lt;br/&gt;   ||                        model_nm: equipment model number&lt;br/&gt;   ||                    manufacturer: equipment manufacturer&lt;br/&gt;   ||                    soc_part_num: equipment part number&lt;br/&gt;   ||               manufacturer_site: equipment manufacturer&lt;br/&gt;   ||               manufacturer_date: equipment manufacturer date&lt;br/&gt;   ||                          cas_id: cas id&lt;br/&gt;   ||                estb_mac_address: estb mac address&lt;br/&gt;   ||                 ecm_mac_address: ecm mac address&lt;br/&gt;   ||            ethernet_mac_address: ethernet mac address&lt;br/&gt;   ||                cmci_mac_address: cmci mac address&lt;br/&gt;   ||               rf4ce_mac_address: rf4ce mac address&lt;br/&gt;   ||       equip_prod_inst_status_cd: equipment production instance status code&lt;br/&gt;   ||&lt;br/&gt;   || NOTE: Amazon Web Services will use the Party account number to invoke this procedure.&lt;br/&gt;   ||       At this time, no other web services/applications will be granted execute privileges.&lt;br/&gt;   ||&lt;br/&gt;   || SOA WEBSERVICE THAT CALLS THIS:   SOLOSetTopBoxService&lt;br/&gt;   ||&lt;br/&gt;   ||&lt;br/&gt;   || =================================================================================================================&lt;br/&gt;   ||                                *** Change History Log ***&lt;br/&gt;   || Tag: Remedy/Jira Ticket ID, Defect ID, or CVS tag/build associated with change&lt;br/&gt;   || =================================================================================================================&lt;br/&gt;   || Vers  Date         Author       Tag      Change Description&lt;br/&gt;   || ====  ===========  ============ ======== ===============================================================&lt;br/&gt;   || 1.0   01-Feb-2015  knoll                 Changes for video provisioning.&lt;br/&gt;   || 2.0   23-APR-2015  Senthil               Defect#2812 Fix&lt;br/&gt;   ||                                          If the account contains an open order then return the devices in&lt;br/&gt;   ||                                           disabled(D) and active(H) status else only return active(H) device&lt;br/&gt;   || 3.0   03-JUL-2015  Senthil               R4 Defect Fix  - Remove recon batch load date check&lt;br/&gt;   || 4.0   08-JUL-2015  Senthil               R4 Defect Fix  - Add logic to include the check for Work Order&lt;br/&gt;   || =================================================================================================================&lt;br/&gt;   */&lt;br/&gt;   l_process_rec          pkg_logging.t_process_rec;&lt;br/&gt;   l_has_open_order       VARCHAR2 (1)              := &apos;N&apos;;&lt;br/&gt;   l_status_cd1           VARCHAR2 (1)              := &apos;H&apos;;&lt;br/&gt;   l_status_cd2           VARCHAR2 (1)              := &apos;H&apos;;&lt;br/&gt;BEGIN&lt;br/&gt;   l_process_rec.process_name := &apos;SP_GET_SETTOP_BOX&apos;;&lt;br/&gt;   pkg_logging.begin_process (l_process_rec,&lt;br/&gt;                                 &apos;caller=&apos;&lt;br/&gt;                              || USER&lt;br/&gt;                              || &apos; ,account_number=&apos;&lt;br/&gt;                              || in_account_number&lt;br/&gt;                              || &apos; ,in_audit_user=&apos;&lt;br/&gt;                              || in_audit_user&lt;br/&gt;                             );&lt;br/&gt;&lt;br/&gt;   IF TRIM (in_account_number) IS NULL&lt;br/&gt;   THEN&lt;br/&gt;      out_error_label := &apos;No Account Number Provided&apos;;&lt;br/&gt;   ELSE&lt;br/&gt;      --If the account contains an open video product/work order then return equipment in both disabled(D) and active(H) status&lt;br/&gt;      --else only return active(H) equipment&lt;br/&gt;      BEGIN&lt;br/&gt;         SELECT &apos;Y&apos;&lt;br/&gt;           INTO l_has_open_order&lt;br/&gt;           FROM chtr.t_bus_inter_vantage_ord_xref x INNER JOIN chtr.t_prod_order_status po&lt;br/&gt;                ON (x.bus_interact_id = po.product_order_id)&lt;br/&gt;                INNER JOIN chtr.t_prod_order_item poi&lt;br/&gt;                ON (poi.product_order_id = po.product_order_id)&lt;br/&gt;                INNER JOIN chtr.t_account_vantage_xref acct_xref&lt;br/&gt;                ON (acct_xref.account_id = poi.account_id)&lt;br/&gt;          WHERE acct_xref.sub_acct_num = in_account_number&lt;br/&gt;            AND poi.impacted_line_of_business_cd = &apos;C&apos;&lt;br/&gt;            AND product_order_status_cd IN (&apos;I&apos;, &apos;O&apos;);&lt;br/&gt;      EXCEPTION&lt;br/&gt;         WHEN NO_DATA_FOUND&lt;br/&gt;         THEN&lt;br/&gt;            l_has_open_order := &apos;N&apos;;&lt;br/&gt;         WHEN TOO_MANY_ROWS&lt;br/&gt;         THEN&lt;br/&gt;            l_has_open_order := &apos;Y&apos;;&lt;br/&gt;      END;&lt;br/&gt;&lt;br/&gt;      IF l_has_open_order = &apos;N&apos;&lt;br/&gt;      THEN&lt;br/&gt;         BEGIN&lt;br/&gt;            SELECT &apos;Y&apos;&lt;br/&gt;              INTO l_has_open_order&lt;br/&gt;              FROM chtr.t_bus_inter_vantage_ord_xref ox INNER JOIN chtr.t_prod_order_status pos&lt;br/&gt;                   ON (ox.bus_interact_id = pos.product_order_id)&lt;br/&gt;                   INNER JOIN chtr.t_busn_intrn_vnt_job_xref jx&lt;br/&gt;                   ON (ox.ord_no = jx.order_num)&lt;br/&gt;                   INNER JOIN chtr.t_work_order_item woi&lt;br/&gt;                   ON (woi.work_order_id = jx.bus_interact_id)&lt;br/&gt;                   INNER JOIN chtr.t_account_vantage_xref acct_xref&lt;br/&gt;                   ON (acct_xref.account_id = woi.account_id)&lt;br/&gt;             WHERE acct_xref.sub_acct_num = in_account_number&lt;br/&gt;               AND woi.impacted_line_of_business_cd = &apos;C&apos;&lt;br/&gt;               AND pos.product_order_status_cd IN (&apos;I&apos;, &apos;O&apos;);&lt;br/&gt;         EXCEPTION&lt;br/&gt;            WHEN NO_DATA_FOUND&lt;br/&gt;            THEN&lt;br/&gt;               l_has_open_order := &apos;N&apos;;&lt;br/&gt;            WHEN TOO_MANY_ROWS&lt;br/&gt;            THEN&lt;br/&gt;               l_has_open_order := &apos;Y&apos;;&lt;br/&gt;         END;&lt;br/&gt;      END IF;&lt;br/&gt;&lt;br/&gt;      IF l_has_open_order = &apos;Y&apos;&lt;br/&gt;      THEN&lt;br/&gt;         l_status_cd2 := &apos;D&apos;;&lt;br/&gt;      END IF;&lt;br/&gt;&lt;br/&gt;      pkg_logging.log_debug (l_process_rec,&lt;br/&gt;                             &apos;l_has_open_order = &apos; || l_has_open_order&lt;br/&gt;                            );&lt;br/&gt;&lt;br/&gt;      OPEN out_stb_cur FOR&lt;br/&gt;         SELECT serial_num, model_nm, manufacturer, soc_part_num,&lt;br/&gt;                manufacturer_site, manufacturer_date,&lt;br/&gt;                DECODE (manufacturer, &apos;WRLDB&apos;, NVL (cas_id, 1), NULL) cas_id,&lt;br/&gt;                estb_mac_address, ecm_mac_address, ethernet_mac_address,&lt;br/&gt;                cmci_mac_address, rf4ce_mac_address,&lt;br/&gt;                epi.equip_prod_inst_status_cd&lt;br/&gt;           FROM t_account_vantage_xref xref INNER JOIN t_account a&lt;br/&gt;                ON a.account_id = xref.account_id AND a.record_stat = &apos;A&apos;&lt;br/&gt;                INNER JOIN t_equip_instance_account epia&lt;br/&gt;                ON epia.account_id = xref.account_id&lt;br/&gt;                   AND epia.record_stat = &apos;A&apos;&lt;br/&gt;                INNER JOIN t_equip_prod_inst epi&lt;br/&gt;                ON epi.equip_prod_inst_id = epia.equip_prod_inst_id&lt;br/&gt;              AND epi.record_stat = &apos;A&apos;&lt;br/&gt;                INNER JOIN t_settop_box_instance stbi&lt;br/&gt;                ON stbi.settop_box_instance_id = epi.equip_prod_inst_id&lt;br/&gt;              AND stbi.record_stat = &apos;A&apos;&lt;br/&gt;          WHERE xref.sub_acct_num = in_account_number&lt;br/&gt;            AND epi.equip_prod_inst_status_cd IN (l_status_cd1, l_status_cd2);&lt;br/&gt;&lt;br/&gt;      out_error_label := &apos;SUCCESS&apos;;&lt;br/&gt;   END IF;&lt;br/&gt;&lt;br/&gt;   pkg_logging.end_process (l_process_rec, &apos;SUCCESS&apos;);&lt;br/&gt;EXCEPTION&lt;br/&gt;   WHEN OTHERS&lt;br/&gt;   THEN&lt;br/&gt;      -- Return output error label&lt;br/&gt;      pkg_logging.log_exception (l_process_rec,&lt;br/&gt;                                    &apos;account_number=&apos;&lt;br/&gt;                                 || in_account_number&lt;br/&gt;                                 || DBMS_UTILITY.format_error_stack ()&lt;br/&gt;                                );&lt;br/&gt;      out_error_label := &apos;FAILURE&apos;;&lt;br/&gt;      pkg_logging.end_process (l_process_rec, &apos;FAILURE&apos;);&lt;br/&gt;END sp_get_settop_box;</source>
<body>CREATE OR REPLACE PROCEDURE      CHTR.SP_GET_SETTOP_BOX (&lt;br/&gt;   out_error_label     OUT      VARCHAR2,&lt;br/&gt;   out_stb_cur         OUT      pkg_osb_service.ref_cur_type,&lt;br/&gt;   in_audit_user       IN       VARCHAR2,&lt;br/&gt;   in_account_number   IN       VARCHAR2&lt;br/&gt;)&lt;br/&gt;AS&lt;br/&gt;   /*&lt;br/&gt;   ||==================================================================================================================&lt;br/&gt;   ||          Name: SP_GET_SETTOP_BOX&lt;br/&gt;   ||          Type: PROCEDURE&lt;br/&gt;   ||        Author: Senthil&lt;br/&gt;   ||  Created Date: 10/22/2014&lt;br/&gt;   ||&lt;br/&gt;   ||   Description: This procedure will return a list of equipment related to a customer party&lt;br/&gt;   ||&lt;br/&gt;   ||     Called By:&lt;br/&gt;   ||&lt;br/&gt;   || IN Parameters:&lt;br/&gt;   ||      in_account_number: account number (required)&lt;br/&gt;   ||              in account_number: Account number will map to the t_account table.&lt;br/&gt;   ||      in_audit_user: user invoking object&lt;br/&gt;   ||&lt;br/&gt;   || OUT Parameters:&lt;br/&gt;   ||      out_stb_cur (ref cursor) returned columns:&lt;br/&gt;   ||                      serial_num: equipment serial number&lt;br/&gt;   ||                        model_nm: equipment model number&lt;br/&gt;   ||                    manufacturer: equipment manufacturer&lt;br/&gt;   ||                    soc_part_num: equipment part number&lt;br/&gt;   ||               manufacturer_site: equipment manufacturer&lt;br/&gt;   ||               manufacturer_date: equipment manufacturer date&lt;br/&gt;   ||                          cas_id: cas id&lt;br/&gt;   ||                estb_mac_address: estb mac address&lt;br/&gt;   ||                 ecm_mac_address: ecm mac address&lt;br/&gt;   ||            ethernet_mac_address: ethernet mac address&lt;br/&gt;   ||                cmci_mac_address: cmci mac address&lt;br/&gt;   ||               rf4ce_mac_address: rf4ce mac address&lt;br/&gt;   ||       equip_prod_inst_status_cd: equipment production instance status code&lt;br/&gt;   ||&lt;br/&gt;   || NOTE: Amazon Web Services will use the Party account number to invoke this procedure.&lt;br/&gt;   ||       At this time, no other web services/applications will be granted execute privileges.&lt;br/&gt;   ||&lt;br/&gt;   || SOA WEBSERVICE THAT CALLS THIS:   SOLOSetTopBoxService&lt;br/&gt;   ||&lt;br/&gt;   ||&lt;br/&gt;   || =================================================================================================================&lt;br/&gt;   ||                                *** Change History Log ***&lt;br/&gt;   || Tag: Remedy/Jira Ticket ID, Defect ID, or CVS tag/build associated with change&lt;br/&gt;   || =================================================================================================================&lt;br/&gt;   || Vers  Date         Author       Tag      Change Description&lt;br/&gt;   || ====  ===========  ============ ======== ===============================================================&lt;br/&gt;   || 1.0   01-Feb-2015  knoll                 Changes for video provisioning.&lt;br/&gt;   || 2.0   23-APR-2015  Senthil               Defect#2812 Fix&lt;br/&gt;   ||                                          If the account contains an open order then return the devices in&lt;br/&gt;   ||                                           disabled(D) and active(H) status else only return active(H) device&lt;br/&gt;   || 3.0   03-JUL-2015  Senthil               R4 Defect Fix  - Remove recon batch load date check&lt;br/&gt;   || 4.0   08-JUL-2015  Senthil               R4 Defect Fix  - Add logic to include the check for Work Order&lt;br/&gt;   || =================================================================================================================&lt;br/&gt;   */&lt;br/&gt;   l_process_rec          pkg_logging.t_process_rec;&lt;br/&gt;   l_has_open_order       VARCHAR2 (1)              := &apos;N&apos;;&lt;br/&gt;   l_status_cd1           VARCHAR2 (1)              := &apos;H&apos;;&lt;br/&gt;   l_status_cd2           VARCHAR2 (1)              := &apos;H&apos;;&lt;br/&gt;BEGIN&lt;br/&gt;   l_process_rec.process_name := &apos;SP_GET_SETTOP_BOX&apos;;&lt;br/&gt;   pkg_logging.begin_process (l_process_rec,&lt;br/&gt;                                 &apos;caller=&apos;&lt;br/&gt;                              || USER&lt;br/&gt;                              || &apos; ,account_number=&apos;&lt;br/&gt;                              || in_account_number&lt;br/&gt;                              || &apos; ,in_audit_user=&apos;&lt;br/&gt;                              || in_audit_user&lt;br/&gt;                             );&lt;br/&gt;&lt;br/&gt;   IF TRIM (in_account_number) IS NULL&lt;br/&gt;   THEN&lt;br/&gt;      out_error_label := &apos;No Account Number Provided&apos;;&lt;br/&gt;   ELSE&lt;br/&gt;      --If the account contains an open video product/work order then return equipment in both disabled(D) and active(H) status&lt;br/&gt;      --else only return active(H) equipment&lt;br/&gt;      BEGIN&lt;br/&gt;         SELECT &apos;Y&apos;&lt;br/&gt;           INTO l_has_open_order&lt;br/&gt;           FROM chtr.t_bus_inter_vantage_ord_xref x INNER JOIN chtr.t_prod_order_status po&lt;br/&gt;                ON (x.bus_interact_id = po.product_order_id)&lt;br/&gt;                INNER JOIN chtr.t_prod_order_item poi&lt;br/&gt;                ON (poi.product_order_id = po.product_order_id)&lt;br/&gt;                INNER JOIN chtr.t_account_vantage_xref acct_xref&lt;br/&gt;                ON (acct_xref.account_id = poi.account_id)&lt;br/&gt;          WHERE acct_xref.sub_acct_num = in_account_number&lt;br/&gt;            AND poi.impacted_line_of_business_cd = &apos;C&apos;&lt;br/&gt;            AND product_order_status_cd IN (&apos;I&apos;, &apos;O&apos;);&lt;br/&gt;      EXCEPTION&lt;br/&gt;         WHEN NO_DATA_FOUND&lt;br/&gt;         THEN&lt;br/&gt;            l_has_open_order := &apos;N&apos;;&lt;br/&gt;         WHEN TOO_MANY_ROWS&lt;br/&gt;         THEN&lt;br/&gt;            l_has_open_order := &apos;Y&apos;;&lt;br/&gt;      END;&lt;br/&gt;&lt;br/&gt;      IF l_has_open_order = &apos;N&apos;&lt;br/&gt;      THEN&lt;br/&gt;         BEGIN&lt;br/&gt;            SELECT &apos;Y&apos;&lt;br/&gt;              INTO l_has_open_order&lt;br/&gt;              FROM chtr.t_bus_inter_vantage_ord_xref ox INNER JOIN chtr.t_prod_order_status pos&lt;br/&gt;                   ON (ox.bus_interact_id = pos.product_order_id)&lt;br/&gt;                   INNER JOIN chtr.t_busn_intrn_vnt_job_xref jx&lt;br/&gt;                   ON (ox.ord_no = jx.order_num)&lt;br/&gt;                   INNER JOIN chtr.t_work_order_item woi&lt;br/&gt;                   ON (woi.work_order_id = jx.bus_interact_id)&lt;br/&gt;                   INNER JOIN chtr.t_account_vantage_xref acct_xref&lt;br/&gt;                   ON (acct_xref.account_id = woi.account_id)&lt;br/&gt;             WHERE acct_xref.sub_acct_num = in_account_number&lt;br/&gt;               AND woi.impacted_line_of_business_cd = &apos;C&apos;&lt;br/&gt;               AND pos.product_order_status_cd IN (&apos;I&apos;, &apos;O&apos;);&lt;br/&gt;         EXCEPTION&lt;br/&gt;            WHEN NO_DATA_FOUND&lt;br/&gt;            THEN&lt;br/&gt;               l_has_open_order := &apos;N&apos;;&lt;br/&gt;            WHEN TOO_MANY_ROWS&lt;br/&gt;            THEN&lt;br/&gt;               l_has_open_order := &apos;Y&apos;;&lt;br/&gt;         END;&lt;br/&gt;      END IF;&lt;br/&gt;&lt;br/&gt;      IF l_has_open_order = &apos;Y&apos;&lt;br/&gt;      THEN&lt;br/&gt;         l_status_cd2 := &apos;D&apos;;&lt;br/&gt;      END IF;&lt;br/&gt;&lt;br/&gt;      pkg_logging.log_debug (l_process_rec,&lt;br/&gt;                             &apos;l_has_open_order = &apos; || l_has_open_order&lt;br/&gt;                            );&lt;br/&gt;&lt;br/&gt;      OPEN out_stb_cur FOR&lt;br/&gt;         SELECT serial_num, model_nm, manufacturer, soc_part_num,&lt;br/&gt;                manufacturer_site, manufacturer_date,&lt;br/&gt;                DECODE (manufacturer, &apos;WRLDB&apos;, NVL (cas_id, 1), NULL) cas_id,&lt;br/&gt;                estb_mac_address, ecm_mac_address, ethernet_mac_address,&lt;br/&gt;                cmci_mac_address, rf4ce_mac_address,&lt;br/&gt;                epi.equip_prod_inst_status_cd&lt;br/&gt;           FROM t_account_vantage_xref xref INNER JOIN t_account a&lt;br/&gt;                ON a.account_id = xref.account_id AND a.record_stat = &apos;A&apos;&lt;br/&gt;                INNER JOIN t_equip_instance_account epia&lt;br/&gt;                ON epia.account_id = xref.account_id&lt;br/&gt;                   AND epia.record_stat = &apos;A&apos;&lt;br/&gt;                INNER JOIN t_equip_prod_inst epi&lt;br/&gt;                ON epi.equip_prod_inst_id = epia.equip_prod_inst_id&lt;br/&gt;              AND epi.record_stat = &apos;A&apos;&lt;br/&gt;                INNER JOIN t_settop_box_instance stbi&lt;br/&gt;                ON stbi.settop_box_instance_id = epi.equip_prod_inst_id&lt;br/&gt;              AND stbi.record_stat = &apos;A&apos;&lt;br/&gt;          WHERE xref.sub_acct_num = in_account_number&lt;br/&gt;            AND epi.equip_prod_inst_status_cd IN (l_status_cd1, l_status_cd2);&lt;br/&gt;&lt;br/&gt;      out_error_label := &apos;SUCCESS&apos;;&lt;br/&gt;   END IF;&lt;br/&gt;&lt;br/&gt;   pkg_logging.end_process (l_process_rec, &apos;SUCCESS&apos;);&lt;br/&gt;EXCEPTION&lt;br/&gt;   WHEN OTHERS&lt;br/&gt;   THEN&lt;br/&gt;      -- Return output error label&lt;br/&gt;      pkg_logging.log_exception (l_process_rec,&lt;br/&gt;                                    &apos;account_number=&apos;&lt;br/&gt;                                 || in_account_number&lt;br/&gt;                                 || DBMS_UTILITY.format_error_stack ()&lt;br/&gt;                                );&lt;br/&gt;      out_error_label := &apos;FAILURE&apos;;&lt;br/&gt;      pkg_logging.end_process (l_process_rec, &apos;FAILURE&apos;);&lt;br/&gt;END sp_get_settop_box;</body>
</StoredProcedureOraclev10g>